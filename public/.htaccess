<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /

  # ============================================
  # Proxy Rules - Forward to Supabase Edge Functions
  # These require mod_proxy to be enabled
  # ============================================
  
  # Sitemap - proxy to edge function (URL stays as pagelyzer.io/sitemap.xml)
  RewriteRule ^sitemap\.xml$ https://wrjqheztddmazlifbzbi.supabase.co/functions/v1/sitemap [P,L]
  
  # Stripe Webhook - proxy to edge function
  RewriteRule ^api/webhooks/stripe$ https://wrjqheztddmazlifbzbi.supabase.co/functions/v1/stripe-webhook [P,L]
  
  # Facebook Webhooks - proxy to edge function
  RewriteRule ^api/webhooks/facebook/?(.*)$ https://wrjqheztddmazlifbzbi.supabase.co/functions/v1/facebook-webhook?$1 [P,QSA,L]
  
  # eSewa Payment Success Callback - proxy to edge function
  RewriteRule ^api/payments/esewa/success$ https://wrjqheztddmazlifbzbi.supabase.co/functions/v1/esewa-checkout?action=success [P,QSA,L]

  # ============================================
  # SPA Routes - Handled by React Router
  # These routes are caught by React, not proxied
  # ============================================
  # /api/auth/facebook/login/callback -> React FacebookLoginCallback component
  # /api/auth/facebook/page/callback -> React FacebookPageCallback component
  
  # ============================================
  # Standard SPA Rules
  # ============================================
  
  # If requesting an actual existing file or directory, serve it
  RewriteCond %{REQUEST_FILENAME} -f [OR]
  RewriteCond %{REQUEST_FILENAME} -d
  RewriteRule ^ - [L]

  # SPA fallback: everything else goes to index.html
  RewriteRule . /index.html [L]
</IfModule>

# Enable mod_proxy if available (required for [P] flag)
<IfModule mod_proxy.c>
  ProxyPreserveHost On
</IfModule>

# Optional safety: if rewrites are disabled for some reason, still fallback
ErrorDocument 404 /index.html
